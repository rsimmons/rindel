!function e(t,n,r){function o(u,s){if(!n[u]){if(!t[u]){var a="function"==typeof require&&require;if(!s&&a)return a(u,!0);if(i)return i(u,!0);var p=new Error("Cannot find module '"+u+"'");throw p.code="MODULE_NOT_FOUND",p}var l=n[u]={exports:{}};t[u][0].call(l.exports,function(e){var n=t[u][1][e];return o(n?n:e)},l,l.exports,e,t,n,r)}return n[u].exports}for(var i="function"==typeof require&&require,u=0;u<r.length;u++)o(r[u]);return o}({1:[function(e,t,n){"use strict";function r(e){if("app"==e.type){for(var t=r(e.funcExpr),n=[],o=0;o<e.argList.length;o++)n.push(r(e.argList[o]));return{state:f,node:{type:s,funcRef:t,argRefs:n}}}if("varIdent"==e.type)return{state:l,ident:e.ident};if("literal"==e.type)return{state:f,node:{type:p,kind:e.kind,value:e.value}};throw new Error("Unexpected object found in AST")}function o(e,t){function n(e){if(g.hasOwnProperty(e))return o(g[e]),g[e].node;if(y.hasOwnProperty(e))return y[e];var t={type:a,ident:e};return y[e]=t,t}function o(e){if(e.state===f);else{if(e.state===c)throw new Error("Circular binding");if(e.state!==l)throw new Error("Invalid ref state");e.state=c,e.node=n(e.ident),e.state=f}if(e.node.type===s){o(e.node.funcRef);for(var t=0;t<e.node.argRefs.length;t++)o(e.node.argRefs[t])}else if(e.node.type===a);else if(e.node.type!==p)throw new Error("Invalid node type")}function i(e){if(e.state===x)throw new Error("Cycle in binding/reference graph, can't toposort");if(e.state!==E){if(e.state=x,e.type===s){i(e.funcRef.node);for(var t=0;t<e.argRefs.length;t++)i(e.argRefs[t].node)}else if(e.type===a);else if(e.type!==p)throw new Error("Unexpected node type found during toposort");b.push(e),e.state=E}}function u(e){if(e.type===s)return"$_app"+e.topoOrder+".outputSlot";if(e.type===a)return"lexEnv."+e.ident;if(e.type===p)return"$_lit"+e.topoOrder;throw new Error("Unexpected node type found in tree")}for(var d,m=0;m<t.length;m++){var h=t[m];if("yield"===h.type){if(d)throw new Error("Multiple yield clauses found in function body");d=h}}if(!d)throw new Error("No yield clause found in function body");for(var v=r(d.expr),g={},m=0;m<t.length;m++){var h=t[m];if("binding"===h.type){if(g.hasOwnProperty(h.ident))throw new Error("Same name bound more than once");g[h.ident]=r(h.expr)}}var y={};o(v);for(var w in g)o(g[w]);var x=1,E=2,b=[];i(v.node);var S=[];S.push("(function(runtime, startTime, argSlots, baseTopoOrder, lexEnv) {\n"),S.push("  if (argSlots.length !== "+e.length+") { throw new Error('called with wrong number of arguments'); }\n");for(var R=[],T=0,m=0;m<b.length;m++){var V=b[m];if(V.type===s){V.topoOrder=T,T++;for(var L=u(V.funcRef.node),A=[],D=0;D<V.argRefs.length;D++)A.push(u(V.argRefs[D].node));S.push("  var $_app"+V.topoOrder+" = runtime.addApplication(startTime, "+L+", ["+A.join(", ")+"], baseTopoOrder+'"+V.topoOrder+"');\n"),R.push("$_app"+V.topoOrder+".deactivator()")}else if(V.type===a);else{if(V.type!==p)throw new Error("Unexpected node type found in tree");V.topoOrder=T,T++;var O;if("specialFunc"===V.kind)if("ifte"===V.value.func)O="runtime.specialFuncs.ifte";else{if("dotAccess"!==V.value.func)throw new Error("Unrecognized special function");O="runtime.specialFuncs.dotAccess('"+V.value.propName+"')"}else{if("number"!==V.kind)throw new Error("unexpected literal kind");O=V.value.toString()}S.push("  var $_lit"+V.topoOrder+" = runtime.createSlot(); runtime.setSlotValue($_lit"+V.topoOrder+", "+O+", startTime);\n")}}R.reverse();var C=u(b[b.length-1]);S.push("  return {\n"),S.push("    outputSlot: "+C+",\n"),S.push("    deactivator: function() {\n");for(var m=0;m<R.length;m++)S.push("      "+R[m]+";\n");return S.push("    }\n"),S.push("  };\n"),S.push("})"),S.join("")}function i(e){var t=u.parse(e),n=o([],t);return n}var u=e("./parser.js"),s=1,a=2,p=3,l=1,c=2,f=3;t.exports={compile:i}},{"./parser.js":2}],2:[function(e,t,n){t.exports=function(){function e(e,t){function n(){this.constructor=e}n.prototype=t.prototype,e.prototype=new n}function t(e,t,n,r,o,i){this.message=e,this.expected=t,this.found=n,this.offset=r,this.line=o,this.column=i,this.name="SyntaxError"}function n(e){function n(){return e.substring(Oe,De)}function r(t){function n(t,n,r){var o,i;for(o=n;r>o;o++)i=e.charAt(o),"\n"===i?(t.seenCR||t.line++,t.column=1,t.seenCR=!1):"\r"===i||"\u2028"===i||"\u2029"===i?(t.line++,t.column=1,t.seenCR=!0):(t.column++,t.seenCR=!1)}return Ce!==t&&(Ce>t&&(Ce=0,Ie={line:1,column:1,seenCR:!1}),n(Ie,Ce,t),Ce=t),Ie}function o(e){ke>De||(De>ke&&(ke=De,Fe=[]),Fe.push(e))}function i(n,o,i){function u(e){var t=1;for(e.sort(function(e,t){return e.description<t.description?-1:e.description>t.description?1:0});t<e.length;)e[t-1]===e[t]?e.splice(t,1):t++}function s(e,t){function n(e){function t(e){return e.charCodeAt(0).toString(16).toUpperCase()}return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(e){return"\\x0"+t(e)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(e){return"\\x"+t(e)}).replace(/[\u0180-\u0FFF]/g,function(e){return"\\u0"+t(e)}).replace(/[\u1080-\uFFFF]/g,function(e){return"\\u"+t(e)})}var r,o,i,u=new Array(e.length);for(i=0;i<e.length;i++)u[i]=e[i].description;return r=e.length>1?u.slice(0,-1).join(", ")+" or "+u[e.length-1]:u[0],o=t?'"'+n(t)+'"':"end of input","Expected "+r+" but "+o+" found."}var a=r(i),p=i<e.length?e.charAt(i):null;return null!==o&&u(o),new t(null!==n?n:s(o,p),o,p,i,a.line,a.column)}function u(){var e;return e=E()}function s(){var t;return q.test(e.charAt(De))?(t=e.charAt(De),De++):(t=k,0===Pe&&o(N)),t}function a(){var e,t;for(Pe++,e=[],t=s();t!==k;)e.push(t),t=s();return Pe--,e===k&&(t=k,0===Pe&&o(_)),e}function p(){var t,n;if(t=[],U.test(e.charAt(De))?(n=e.charAt(De),De++):(n=k,0===Pe&&o(j)),n!==k)for(;n!==k;)t.push(n),U.test(e.charAt(De))?(n=e.charAt(De),De++):(n=k,0===Pe&&o(j));else t=M;return t}function l(){var t,n,r,i,u,s,l;return t=De,n=a(),n!==k?(45===e.charCodeAt(De)?(r=Y,De++):(r=k,0===Pe&&o(Q)),r===k&&(r=X),r!==k?(i=p(),i===k&&(i=X),i!==k?(46===e.charCodeAt(De)?(u=z,De++):(u=k,0===Pe&&o(B)),u!==k?(s=p(),s!==k?(l=a(),l!==k?(Oe=t,n=$(),t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M)):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t===k&&(t=De,n=a(),n!==k?(45===e.charCodeAt(De)?(r=Y,De++):(r=k,0===Pe&&o(Q)),r===k&&(r=X),r!==k?(i=p(),i!==k?(u=a(),u!==k?(Oe=t,n=$(),t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M)):(De=t,t=M)),t}function c(){var t,n,r,i,u;if(t=De,n=a(),n!==k)if(H.test(e.charAt(De))?(r=e.charAt(De),De++):(r=k,0===Pe&&o(J)),r!==k){for(i=[],G.test(e.charAt(De))?(u=e.charAt(De),De++):(u=k,0===Pe&&o(K));u!==k;)i.push(u),G.test(e.charAt(De))?(u=e.charAt(De),De++):(u=k,0===Pe&&o(K));i!==k?(u=a(),u!==k?(Oe=t,n=W(r,i),t=n):(De=t,t=M)):(De=t,t=M)}else De=t,t=M;else De=t,t=M;return t}function f(){var t,n,r,i;return t=De,n=a(),n!==k?(e.substr(De,5)===Z?(r=Z,De+=5):(r=k,0===Pe&&o(ee)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function d(){var t,n,r,i;return t=De,n=a(),n!==k?(e.substr(De,2)===te?(r=te,De+=2):(r=k,0===Pe&&o(ne)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function m(){var t,n,r,i;return t=De,n=a(),n!==k?(e.substr(De,4)===re?(r=re,De+=4):(r=k,0===Pe&&o(oe)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function h(){var t,n,r,i;return t=De,n=a(),n!==k?(e.substr(De,4)===ie?(r=ie,De+=4):(r=k,0===Pe&&o(ue)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function v(){var t,n,r,i;return t=De,n=a(),n!==k?(44===e.charCodeAt(De)?(r=se,De++):(r=k,0===Pe&&o(ae)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function g(){var t,n,r,i;return t=De,n=a(),n!==k?(46===e.charCodeAt(De)?(r=z,De++):(r=k,0===Pe&&o(B)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function y(){var t,n,r,i;return t=De,n=a(),n!==k?(61===e.charCodeAt(De)?(r=pe,De++):(r=k,0===Pe&&o(le)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function w(){var t,n,r,i;return t=De,n=a(),n!==k?(40===e.charCodeAt(De)?(r=ce,De++):(r=k,0===Pe&&o(fe)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function x(){var t,n,r,i;return t=De,n=a(),n!==k?(41===e.charCodeAt(De)?(r=de,De++):(r=k,0===Pe&&o(me)),r!==k?(i=a(),i!==k?(n=[n,r,i],t=n):(De=t,t=M)):(De=t,t=M)):(De=t,t=M),t}function E(){var e,t;return e=De,t=b(),t!==k&&(Oe=e,t=he(t)),e=t}function b(){var e,t,n;if(e=De,t=[],n=S(),n!==k)for(;n!==k;)t.push(n),n=S();else t=M;return t!==k&&(Oe=e,t=ve(t)),e=t}function S(){var e,t,n,r;return e=De,t=f(),t!==k?(n=R(),n!==k?(Oe=e,t=ge(n),e=t):(De=e,e=M)):(De=e,e=M),e===k&&(e=De,t=c(),t!==k?(n=y(),n!==k?(r=R(),r!==k?(Oe=e,t=ye(t,r),e=t):(De=e,e=M)):(De=e,e=M)):(De=e,e=M)),e}function R(){var e,t,n,r;if(e=De,t=V(),t!==k){if(n=[],r=L(),r!==k)for(;r!==k;)n.push(r),r=L();else n=M;n!==k?(Oe=e,t=we(t,n),e=t):(De=e,e=M)}else De=e,e=M;if(e===k){if(e=De,t=V(),t!==k){if(n=[],r=T(),r!==k)for(;r!==k;)n.push(r),r=T();else n=M;n!==k?(Oe=e,t=xe(t,n),e=t):(De=e,e=M)}else De=e,e=M;e===k&&(e=De,t=V(),t!==k&&(Oe=e,t=Ee(t)),e=t)}return e}function T(){var e,t,n;return e=De,t=g(),t!==k?(n=c(),n!==k?(Oe=e,t=be(n),e=t):(De=e,e=M)):(De=e,e=M),e}function V(){var e,t,n,r,o,i,u;return e=De,t=w(),t!==k?(n=R(),n!==k?(r=x(),r!==k?(Oe=e,t=Ee(n),e=t):(De=e,e=M)):(De=e,e=M)):(De=e,e=M),e===k&&(e=De,t=l(),t!==k&&(Oe=e,t=Se(t)),e=t,e===k&&(e=De,t=d(),t!==k?(n=R(),n!==k?(r=m(),r!==k?(o=R(),o!==k?(i=h(),i!==k?(u=R(),u!==k?(Oe=e,t=Re(n,o,u),e=t):(De=e,e=M)):(De=e,e=M)):(De=e,e=M)):(De=e,e=M)):(De=e,e=M)):(De=e,e=M),e===k&&(e=De,t=c(),t!==k&&(Oe=e,t=Te(t)),e=t))),e}function L(){var e,t,n,r;return e=De,t=w(),t!==k?(n=A(),n!==k?(r=x(),r!==k?(Oe=e,t=Ve(n),e=t):(De=e,e=M)):(De=e,e=M)):(De=e,e=M),e}function A(){var e,t,n,r;return e=De,t=R(),t!==k?(n=v(),n!==k?(r=A(),r!==k?(Oe=e,t=Le(t,r),e=t):(De=e,e=M)):(De=e,e=M)):(De=e,e=M),e===k&&(e=De,t=R(),t!==k&&(Oe=e,t=Ae(t)),e=t),e}function D(e,t){for(var n=e,r=0;r<t.length;r++)n={type:"app",funcExpr:n,argList:t[r]};return n}function O(e,t){for(var n=e,r=0;r<t.length;r++)n={type:"app",funcExpr:{type:"literal",kind:"specialFunc",value:{func:"dotAccess",propName:t[r]}},argList:[n]};return n}var C,I=arguments.length>1?arguments[1]:{},k={},F={start:u},P=u,q=/^[ \t\n\r]/,N={type:"class",value:"[ \\t\\n\\r]",description:"[ \\t\\n\\r]"},_={type:"other",description:"whitespace"},M=k,U=/^[0-9]/,j={type:"class",value:"[0-9]",description:"[0-9]"},X=null,Y="-",Q={type:"literal",value:"-",description:'"-"'},z=".",B={type:"literal",value:".",description:'"."'},$=function(){return parseFloat(n())},H=/^[_a-z]/i,J={type:"class",value:"[_a-z]i",description:"[_a-z]i"},G=/^[_a-z0-9]/i,K={type:"class",value:"[_a-z0-9]i",description:"[_a-z0-9]i"},W=function(e,t){return e+t.join("")},Z="yield",ee={type:"literal",value:"yield",description:'"yield"'},te="if",ne={type:"literal",value:"if",description:'"if"'},re="then",oe={type:"literal",value:"then",description:'"then"'},ie="else",ue={type:"literal",value:"else",description:'"else"'},se=",",ae={type:"literal",value:",",description:'","'},pe="=",le={type:"literal",value:"=",description:'"="'},ce="(",fe={type:"literal",value:"(",description:'"("'},de=")",me={type:"literal",value:")",description:'")"'},he=function(e){return e},ve=function(e){return e},ge=function(e){return{type:"yield",expr:e}},ye=function(e,t){return{type:"binding",ident:e,expr:t}},we=function(e,t){return D(e,t)},xe=function(e,t){return O(e,t)},Ee=function(e){return e},be=function(e){return e},Se=function(e){return{type:"literal",kind:"number",value:e}},Re=function(e,t,n){return{type:"app",funcExpr:{type:"literal",kind:"specialFunc",value:{func:"ifte"}},argList:[e,t,n]}},Te=function(e){return{type:"varIdent",ident:e}},Ve=function(e){return e},Le=function(e,t){return[e].concat(t)},Ae=function(e){return[e]},De=0,Oe=0,Ce=0,Ie={line:1,column:1,seenCR:!1},ke=0,Fe=[],Pe=0;if("startRule"in I){if(!(I.startRule in F))throw new Error("Can't start parsing from rule \""+I.startRule+'".');P=F[I.startRule]}if(C=P(),C!==k&&De===e.length)return C;throw C!==k&&De<e.length&&o({type:"end",description:"end of input"}),i(null,Fe,ke)}return e(t,Error),{SyntaxError:t,parse:n}}()},{}],3:[function(e,t,n){"use strict";t.exports={code:"yield mousePos",main:main,commentary:"<p>This program simply yields the mouse position unchanged, causing the square to be at the same position as the mouse.</p>"}},{}],4:[function(e,t,n){"use strict";t.exports={code:"yield delay1(mousePos)",main:main,commentary:'<p>This program yields the mouse position delayed by 1 second. Note the behavior of the "JS timeout outstanding" value on the left, as you alternately move the mouse and stop moving it for a bit. If there are "buffered" mouse movements still to be played out, there is a timeout set for those. If the mouse has been still for a least one second, no changes will be buffered and so no timeout will be set.</p><p>Also note, if you quickly move the pointer and click to start this same program again, the square jumps to match the mouse position. This is because the delay1 function relays its initial input as its output for the first second.</p>'}},{}],5:[function(e,t,n){"use strict";t.exports={code:"yield if mouseDown then mousePos else delay1(mousePos)",main:main,commentary:'<p>This program switches between yielding the current mouse position and the delayed mouse position, based on whether the mouse button is down. The if/then/else syntax is an expression (like the ternary operator "?:"), not a statement.</p><p>Note that even if the mouse button is held down, the delayed position is computed. This is necessary to avoid "time leaks", i.e. we don\'t know when we\'ll need the value when the mouse button is released, so we must keep it up to date.</p>'}},{}],6:[function(e,t,n){"use strict";t.exports={code:"yield (if mouseDown then id else delay1)(mousePos)",main:main,commentary:'<p>This program illustrates a subtle and important detail, when compared to the previous program. In this program, we apply a function to the mouse position, but the value of that function we apply is itself dynamic. It switches from the value "id" (identity function) to the value "delay1". This is similar to the previous program, except when the mouse is released, the square stays at the current mouse position. This is because when id or delay1 are switched into action, they always start "from scratch". Only one is running at a time. And when delay1 starts, it mirrors its input for the first second. In the previous program, delay1 is always running.</p>'}},{}],7:[function(e,t,n){"use strict";function r(e,t,n,r,o){if(1!==n.length)throw new Error("got wrong number of arguments");var i=e.createSlot(),u=n[0],s=[],a=null,p=function(){if(s.length>0&&!a){var t=s[0],n={time:t.time,topoOrder:r,closure:l};e.priorityQueue.insert(n),a=n}},l=function(t){if(0===s.length)throw new Error("no changes to make");var n=s.shift();if(t!==n.time)throw new Error("times do not match");e.setSlotValue(i,n.value,t),a=null,p()},c=function(t){var n=e.getSlotValue(u);s.push({time:t+1,value:n}),p()},f=function(t){e.priorityQueue.insert({time:t,topoOrder:r,closure:c})},d=e.getSlotValue(u);return e.setSlotValue(i,d,t),e.addTrigger(u,f),{outputSlot:i,deactivator:function(){e.removeTrigger(u,f),a&&e.priorityQueue.remove(a)}}}var o=e("./primUtils"),i=o.liftN;t.exports={add:i(function(e,t){return e+t},2),sub:i(function(e,t){return e-t},2),id:i(function(e){return e},1),Vec2:i(function(e,t){return{x:e,y:t}},2),delay1:r}},{"./primUtils":12}],8:[function(e,t,n){"use strict";var r=e("./pq"),o=function(){this.priorityQueue=new r};o.prototype.createLexEnv=function(e){return this.deriveLexEnv(null,e)},o.prototype.deriveLexEnv=function(e,t){var n={};for(var r in t)t.hasOwnProperty(r)&&(n[r]={value:t[r],writeable:!1,enumerable:!0});return Object.create(e,n)},o.prototype.createSlot=function(){return{currentValue:void 0,triggers:[]}},o.prototype.getSlotValue=function(e){return e.value},o.prototype.setSlotValue=function(e,t,n){e.value=t;for(var r=0;r<e.triggers.length;r++)e.triggers[r](n)},o.prototype.addTrigger=function(e,t){e.triggers.push(t)},o.prototype.removeTrigger=function(e,t){for(var n,r=0;r<e.triggers.length;r++)if(e.triggers[r]===t){if(void 0!==n)throw new Error("found two identical triggers");n=r}if(void 0===n)throw new Error("no matching trigger found");e.triggers.splice(n,1)},o.prototype.runToTime=function(e){for(;;){if(this.priorityQueue.isEmpty())return null;var t=this.priorityQueue.peek();if(t.time>e)return t.time;this.runNextTask()}},o.prototype.runNextTask=function(){var e=this.priorityQueue.pull();e.closure(e.time)},o.prototype.isRunnable=function(){return!this.priorityQueue.isEmpty()},o.prototype.addApplication=function(e,t,n,r,o){function i(e){void 0!==u&&u();var i=s.getSlotValue(t),p=i(s,e,n,r,o);if(void 0===p)throw new Error("activator did not return result");u=p.deactivator,s.setSlotValue(a,s.getSlotValue(p.outputSlot),e),s.addTrigger(p.outputSlot,function(e){s.setSlotValue(a,s.getSlotValue(p.outputSlot),e)})}var u,s=this,a=s.createSlot();return i(e),s.addTrigger(t,i),{outputSlot:a,deactivator:function(){s.removeTrigger(t,i),u()}}},o.prototype.builtins=e("./builtins"),o.prototype.specialFuncs=e("./specialFuncs"),t.exports=o},{"./builtins":7,"./pq":11,"./specialFuncs":13}],9:[function(e,t,n){t.exports=e("./lib/heap")},{"./lib/heap":10}],10:[function(e,t,n){(function(){var e,r,o,i,u,s,a,p,l,c,f,d,m,h,v;o=Math.floor,c=Math.min,r=function(e,t){return t>e?-1:e>t?1:0},l=function(e,t,n,i,u){var s;if(null==n&&(n=0),null==u&&(u=r),0>n)throw new Error("lo must be non-negative");for(null==i&&(i=e.length);i>n;)s=o((n+i)/2),u(t,e[s])<0?i=s:n=s+1;return[].splice.apply(e,[n,n-n].concat(t)),t},s=function(e,t,n){return null==n&&(n=r),e.push(t),h(e,0,e.length-1,n)},u=function(e,t){var n,o;return null==t&&(t=r),n=e.pop(),e.length?(o=e[0],e[0]=n,v(e,0,t)):o=n,o},p=function(e,t,n){var o;return null==n&&(n=r),o=e[0],e[0]=t,v(e,0,n),o},a=function(e,t,n){var o;return null==n&&(n=r),e.length&&n(e[0],t)<0&&(o=[e[0],t],t=o[0],e[0]=o[1],v(e,0,n)),t},i=function(e,t){var n,i,u,s,a,p;for(null==t&&(t=r),s=function(){p=[];for(var t=0,n=o(e.length/2);n>=0?n>t:t>n;n>=0?t++:t--)p.push(t);return p}.apply(this).reverse(),a=[],i=0,u=s.length;u>i;i++)n=s[i],a.push(v(e,n,t));return a},m=function(e,t,n){var o;return null==n&&(n=r),o=e.indexOf(t),-1!==o?(h(e,0,o,n),v(e,o,n)):void 0},f=function(e,t,n){var o,u,s,p,l;if(null==n&&(n=r),u=e.slice(0,t),!u.length)return u;for(i(u,n),l=e.slice(t),s=0,p=l.length;p>s;s++)o=l[s],a(u,o,n);return u.sort(n).reverse()},d=function(e,t,n){var o,s,a,p,f,d,m,h,v,g;if(null==n&&(n=r),10*t<=e.length){if(p=e.slice(0,t).sort(n),!p.length)return p;for(a=p[p.length-1],h=e.slice(t),f=0,m=h.length;m>f;f++)o=h[f],n(o,a)<0&&(l(p,o,0,null,n),p.pop(),a=p[p.length-1]);return p}for(i(e,n),g=[],s=d=0,v=c(t,e.length);v>=0?v>d:d>v;s=v>=0?++d:--d)g.push(u(e,n));return g},h=function(e,t,n,o){var i,u,s;for(null==o&&(o=r),i=e[n];n>t&&(s=n-1>>1,u=e[s],o(i,u)<0);)e[n]=u,n=s;return e[n]=i},v=function(e,t,n){var o,i,u,s,a;for(null==n&&(n=r),i=e.length,a=t,u=e[t],o=2*t+1;i>o;)s=o+1,i>s&&!(n(e[o],e[s])<0)&&(o=s),e[t]=e[o],t=o,o=2*t+1;return e[t]=u,h(e,a,t,n)},e=function(){function e(e){this.cmp=null!=e?e:r,this.nodes=[]}return e.push=s,e.pop=u,e.replace=p,e.pushpop=a,e.heapify=i,e.updateItem=m,e.nlargest=f,e.nsmallest=d,e.prototype.push=function(e){return s(this.nodes,e,this.cmp)},e.prototype.pop=function(){return u(this.nodes,this.cmp)},e.prototype.peek=function(){return this.nodes[0]},e.prototype.contains=function(e){return-1!==this.nodes.indexOf(e)},e.prototype.replace=function(e){return p(this.nodes,e,this.cmp)},e.prototype.pushpop=function(e){return a(this.nodes,e,this.cmp)},e.prototype.heapify=function(){return i(this.nodes,this.cmp)},e.prototype.updateItem=function(e){return m(this.nodes,e,this.cmp)},e.prototype.clear=function(){return this.nodes=[]},e.prototype.empty=function(){return 0===this.nodes.length},e.prototype.size=function(){return this.nodes.length},e.prototype.clone=function(){var t;return t=new e,t.nodes=this.nodes.slice(0),t},e.prototype.toArray=function(){return this.nodes.slice(0)},e.prototype.insert=e.prototype.push,e.prototype.top=e.prototype.peek,e.prototype.front=e.prototype.peek,e.prototype.has=e.prototype.contains,e.prototype.copy=e.prototype.clone,e}(),function(e,r){return"function"==typeof define&&define.amd?define([],r):"object"==typeof n?t.exports=r():e.Heap=r()}(this,function(){return e})}).call(this)},{}],11:[function(e,t,n){"use strict";var r=e("heap"),o=function(){this.heap=new r(function(e,t){return e.time===t.time?e.topoOrder<t.topoOrder?-1:t.topoOrder>e.topoOrder?1:0:e.time-t.time})};o.prototype.isEmpty=function(){return this.pullRemoved(),this.heap.empty()},o.prototype.insert=function(e){this.heap.push(e)},o.prototype.peek=function(){return this.pullRemoved(),this.heap.peek()},o.prototype.pull=function(){this.pullRemoved();for(var e=this.heap.pop();;){if(this.pullRemoved(),this.heap.empty())break;var t=this.heap.peek();if(t.time!==e.time||t.topoOrder!==e.topoOrder||t.closure!==e.closure)break;this.heap.pop()}return e},o.prototype.remove=function(e){e.removed=!0},o.prototype.pullRemoved=function(){for(;!this.heap.empty();){var e=this.heap.peek();if(!e.removed)break;this.heap.pop()}},t.exports=o},{heap:9}],12:[function(e,t,n){"use strict";function r(e,t){return function(n,r,o,i,u){if(o.length!==t)throw new Error("got wrong number of arguments");var s=n.createSlot(),a=function(r){for(var i=[],u=0;t>u;u++)i.push(n.getSlotValue(o[u]));var a=e.apply(null,i);n.setSlotValue(s,a,r)},p=function(e){n.priorityQueue.insert({time:e,topoOrder:i,closure:a})};a(r);for(var l=0;t>l;l++)n.addTrigger(o[l],p);return{outputSlot:s,deactivator:function(){for(var e=0;t>e;e++)n.removeTrigger(o[e],p)}}}}t.exports={liftN:r}},{}],13:[function(e,t,n){"use strict";var r=e("./primUtils"),o=r.liftN;t.exports={ifte:o(function(e,t,n){return e?t:n},3),dotAccess:function(e){return o(function(t){return t[e]},1)}}},{"./primUtils":12}],14:[function(require,module,exports){"use strict";function getMasterTime(){return.001*(Date.now()-initialDateNow)}function tryRunning(){if(runtime.isRunnable()){var e=getMasterTime(),t=runtime.runToTime(e);t&&!timeoutID&&(timeoutID=window.setTimeout(function(){timeoutID=null,updateInternalsDisplay(),tryRunning()},1e3*(t-e)),updateInternalsDisplay())}}function updateInternalsDisplay(){var e=[];e.push("Output changes: "+internals.outputChanges),e.push("JS timeout outstanding: "+!!timeoutID),document.getElementById("internals-notes").innerHTML=e.join("<br>")}function witnessOutput(e){var t=currentResult.outputSlot.value;internals.outputChanges+=1,updateInternalsDisplay();var n=document.getElementById("square");n.style.left=t.x+1+"px",n.style.top=t.y+1+"px"}function startCompiledProgram(e){if(currentResult){if(currentResult.deactivator(),runtime.removeTrigger(currentResult.outputSlot,witnessOutput),timeoutID&&(window.clearTimeout(timeoutID),timeoutID=null,updateInternalsDisplay()),runtime.isRunnable())throw new Error("something went wrong");for(var t in rootLexEnv)if(rootLexEnv[t].triggers.length>0)throw new Error("something went wrong")}runtime=new Runtime,rootLexEnv=runtime.createLexEnv({mouseX:runtime.createSlot(),mouseY:runtime.createSlot(),mousePos:runtime.createSlot(),mouseDown:runtime.createSlot()}),runtime.setSlotValue(rootLexEnv.mouseX,inputValues.mouseX,0),runtime.setSlotValue(rootLexEnv.mouseY,inputValues.mouseY,0),runtime.setSlotValue(rootLexEnv.mousePos,{x:inputValues.mouseX,y:inputValues.mouseY},0),runtime.setSlotValue(rootLexEnv.mouseDown,inputValues.mouseDown,0);for(var t in runtime.builtins)rootLexEnv[t]=runtime.createSlot(),runtime.setSlotValue(rootLexEnv[t],runtime.builtins[t],0);internals={outputChanges:0},updateInternalsDisplay(),currentResult=e(runtime,0,[],"",rootLexEnv),witnessOutput(0),runtime.addTrigger(currentResult.outputSlot,witnessOutput),tryRunning()}function compileAndStartProgram(code){var mainFuncSrc=Compiler.compile(code);console.log("compiled to JS:"),console.log(mainFuncSrc);var mainFunc=eval(mainFuncSrc);startCompiledProgram(mainFunc)}function startDemoProg(e){document.getElementById("code-column-editor").value=e.code,document.getElementById("code-column-commentary").innerHTML=e.commentary||"",compileAndStartProgram(e.code)}function createDemoControls(){var e=document.getElementById("demos-list");for(var t in demoProgs){var n=document.createElement("LI");n.setAttribute("class","demo-choice"),n.appendChild(document.createTextNode(t)),e.appendChild(n)}e.firstChild.classList.add("demo-active"),document.addEventListener("click",function(t){if(t.target.classList.contains("demo-choice")){for(var n=0;n<e.childNodes.length;n++)e.childNodes[n].classList.remove("demo-active");t.target.classList.add("demo-active");var r=t.target.textContent,o=demoProgs[r];startDemoProg(o)}},!1),document.getElementById("compile-button").addEventListener("click",function(e){compileAndStartProgram(document.getElementById("code-column-editor").value)})}var Runtime=require("../runtime"),Compiler=require("../compiler"),demoProgs={"same position":require("./progs/prog0"),"delayed position":require("./progs/prog1"),"switch on button":require("./progs/prog2"),"dynamic application":require("./progs/prog3")},initialDateNow=Date.now(),runtime,rootLexEnv,timeoutID,currentResult,inputValues={mouseX:0,mouseY:0,mouseDown:!1},internals;document.addEventListener("mousemove",function(e){var t=getMasterTime();inputValues.mouseX=e.clientX||e.pageX,inputValues.mouseY=e.clientY||e.pageY,runtime.setSlotValue(rootLexEnv.mouseX,inputValues.mouseX,t),runtime.setSlotValue(rootLexEnv.mouseY,inputValues.mouseY,t),runtime.setSlotValue(rootLexEnv.mousePos,{x:inputValues.mouseX,y:inputValues.mouseY},t),tryRunning()},!1),document.addEventListener("mousedown",function(e){if(0===e.button){var t=getMasterTime();inputValues.mouseDown=!0,runtime.setSlotValue(rootLexEnv.mouseDown,inputValues.mouseDown,t),tryRunning()}},!1),document.addEventListener("mouseup",function(e){if(0===e.button){var t=getMasterTime();inputValues.mouseDown=!1,runtime.setSlotValue(rootLexEnv.mouseDown,inputValues.mouseDown,t),tryRunning()}},!1),document.addEventListener("DOMContentLoaded",function(){createDemoControls(),startDemoProg(demoProgs["same position"])})},{"../compiler":1,"../runtime":8,"./progs/prog0":3,"./progs/prog1":4,"./progs/prog2":5,"./progs/prog3":6}]},{},[14]);
