'use strict';

var Runtime = require('../runtime');

var demoProgs = {
  prog0: require('./progs/prog0'),
  prog1: require('./progs/prog1'),
};

var initialDateNow = Date.now();
var runtime;
var rootLexEnv;
var finalOutput;
var timeoutID;
var currentDeactivator;

function getMasterTime() {
  return 0.001*(Date.now() - initialDateNow);
}

// "run" the runtime as necessary
function tryRunning() {
  if (!runtime.isRunnable()) {
    return;
  }

  var t = getMasterTime();
  var nextTime = runtime.runToTime(t);
  // console.log(t, nextTime);
  var outputVal = runtime.getSlotValue(finalOutput)
  console.log('output is now', outputVal);
  var squareElem = document.getElementById('square');
  squareElem.style.left = (outputVal - 17) + 'px';
  squareElem.style.top = '100px';

  if (nextTime && !timeoutID) {
    timeoutID = window.setTimeout(function() {
      timeoutID = null;
      tryRunning();
    }, 1000*(nextTime-t));
  }
}

document.addEventListener('mousemove', function(e) {
  var t = getMasterTime();
  var mouseX = e.clientX||e.pageX;
  var mouseY = e.clientY||e.pageY;
  // console.log('mouse', t, mouseX, mouseY);
  runtime.setSlotValue(rootLexEnv.mouseX, mouseX, t);
  runtime.setSlotValue(rootLexEnv.mouseY, mouseY, t);

  tryRunning();
}, false);

function startDemoProg(prog) {
  if (currentDeactivator) {
    // deactivate current running program
    currentDeactivator();

    // remove any timeout that's set
    if (timeoutID) {
      window.clearTimeout(timeoutID);
      timeoutID = null;
    }

    // begin sanity checking

    // make sure its not runnable
    if (runtime.isRunnable()) {
      throw new Error('something went wrong');
    }

    // make sure there are no triggers on global slots
    for (var k in rootLexEnv) {
      if (rootLexEnv[k].triggers.length > 0) {
        throw new Error('something went wrong');
      }
    }

    // end sanity checking
  }

  runtime = new Runtime();

  rootLexEnv = runtime.createLexEnv({
    add: runtime.createSlot(),
    delay1: runtime.createSlot(),
    mouseX: runtime.createSlot(),
    mouseY: runtime.createSlot(),
  });

  runtime.setSlotValue(rootLexEnv.add, runtime.primitives.add, 0);
  runtime.setSlotValue(rootLexEnv.delay1, runtime.primitives.delay1, 0);
  runtime.setSlotValue(rootLexEnv.mouseX, 0, 0);
  runtime.setSlotValue(rootLexEnv.mouseY, 0, 0);

  finalOutput = runtime.createSlot()

  // assume main activator definition has been generated by compiler
  currentDeactivator = prog.main(runtime, 0, [], finalOutput, '', rootLexEnv);

  document.getElementById('code-column-code').textContent = prog.code;
  console.log('initial output is', runtime.getSlotValue(finalOutput));

  tryRunning();
}

function createDemoControls() {
  var demosListElem = document.getElementById('demos-list');

  for (var name in demoProgs) {
    var li = document.createElement('LI');
    li.setAttribute('class', 'demo-choice');
    li.appendChild(document.createTextNode(name));
    demosListElem.appendChild(li);

/*
    var ce = document.createElement('CODE');
    ce.className = 'language-javascript';
    var extractedCode = /\/\/SHOWBEGIN([^]*)\/\/SHOWEND/gm.exec(demos[name].code)[1].trim();
    ce.appendChild(document.createTextNode(extractedCode));

    var pe = document.createElement('PRE');
    pe.className = 'code-wrapper';
    pe.style.display = 'none';
    pe.appendChild(ce);

    codeColumnElem.appendChild(pe);

    demos[k].preElem = pe;
*/
  }

  document.addEventListener('click', function(e) {
    if (e.target.className === 'demo-choice') {
      var name = e.target.textContent;
      var prog = demoProgs[name]
      startDemoProg(prog);
    }
  }, false);
}

document.addEventListener('DOMContentLoaded', function() {
  createDemoControls();

  startDemoProg(demoProgs.prog0);
});
